<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="xVaccine Treatment Planner - Schedule and manage your vaccination appointments">
    <meta name="theme-color" content="#0a4d3c">
    <title>xVaccine Treatment Planner</title>
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Source+Sans+3:wght@300;400;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>xVaccine Treatment Planner</h1>
            <p class="subtitle">Long-acting injectable treatment scheduling</p>
        </header>

        <!-- Step 1: Choose Treatment Type -->
        <div id="step1" class="card">
            <h2 class="card-title">
                <span class="step-indicator">1</span>
                Select Treatment Type
            </h2>
            <div class="info-box">
                Please select whether you are starting new treatment or continuing established long-acting treatment.
            </div>
            <div class="option-cards">
                <div class="option-card" onclick="selectTreatmentType('new')">
                    <div class="option-icon">üÜï</div>
                    <div class="option-title">Starting New Treatment</div>
                    <div class="option-description">
                        Begin long-acting injectable treatment with or without oral lead-in
                    </div>
                </div>
                <div class="option-card" onclick="selectTreatmentType('continuation')">
                    <div class="option-icon">üîÑ</div>
                    <div class="option-title">Continuation Treatment</div>
                    <div class="option-description">
                        Already established on 2-month injection schedule
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2a: New Treatment - Lead-in Selection -->
        <h2 class="card-title">
            <span class="step-indicator">2</span>
            Treatment Initiation Method
        </h2>
        <div class="info-box">
            Choose how you will begin your long-acting injectable treatment.
        </div>
        <div class="option-cards">
            <div class="option-card" onclick="selectLeadIn('oral')">
                <div class="option-icon">üíä</div>
                <div class="option-title">With Oral Lead-in</div>
                <div class="option-description">
                    Complete 28 days of oral tablets before first injection
                </div>
            </div>
            <div class="option-card" onclick="selectLeadIn('direct')">
                <div class="option-icon">üíâ</div>
                <div class="option-title">Direct to Injections</div>
                <div class="option-description">
                    Start immediately with monthly injections
                </div>
            </div>
        </div>
    </div>

    <!-- Step 2b: Oral Lead-in Confirmation -->
    <div id="step2b" class="card hidden">
        <h2 class="card-title">
            <span class="step-indicator">2</span>
            Oral Lead-in Completion
        </h2>
        <div class="warning-box">
            <strong>Important:</strong> Before scheduling injections, you must complete at least 28 days of oral lead-in
            therapy:
            <ul>
                <li>1 tablet of cabotegravir (30mg) daily</li>
                <li>1 tablet of rilpivirine (25mg) daily</li>
            </ul>
        </div>
        <div class="input-group">
            <label for="oralCompleteDate">Date Oral Lead-in Completed (Day 28):</label>
            <input type="date" id="oralCompleteDate" required>
        </div>
        <button class="btn btn-primary" onclick="proceedFromOralLeadIn()">
            Continue to Schedule
        </button>
        <button class="btn btn-secondary" onclick="goBack('step2a')">
            ‚Üê Back
        </button>
    </div>

    <!-- Step 3: Target Date Selection -->
    <div id="step3" class="card hidden">
        <h2 class="card-title">
            <span class="step-indicator">3</span>
            Select Target Treatment Date
        </h2>
        <div class="info-box">
            <strong>Choose your Target Treatment Date carefully:</strong>
            <ul>
                <li>This date will be used for all future injections each month</li>
                <li>Select a day between the 1st and 28th for consistency in shorter months</li>
                <li>Choose a time that aligns with your clinic hours</li>
                <li>Injections can be given ¬±7 days from this target if needed</li>
            </ul>
        </div>
        <div class="input-group">
            <label for="targetDate">Target Treatment Date:</label>
            <input type="date" id="targetDate" required>
        </div>
        <div class="input-group">
            <label for="targetTime">Preferred Appointment Time:</label>
            <input type="time" id="targetTime" value="10:00" required>
        </div>
        <div id="dateWarning" class="warning-box hidden">
            ‚ö†Ô∏è <strong>Note:</strong> Selected day is after the 28th. This may cause scheduling issues in months with
            fewer than 31 days. Consider selecting an earlier day of the month.
        </div>
        <button class="btn btn-primary" onclick="generateSchedule()">
            Generate Schedule
        </button>
        <button class="btn btn-secondary" onclick="goBackFromStep3()">
            ‚Üê Back
        </button>
    </div>

    <!-- Step 4: Review Schedule -->
    <div id="step4" class="card hidden">
        <h2 class="card-title">
            <span class="step-indicator">4</span>
            Your Treatment Schedule
        </h2>
        <div class="info-box">
            <strong>Target Treatment Date</strong> is shown in <strong style="color: #22c55e;">green</strong>.
            If needed, you can schedule within the <strong style="color: #fbbf24;">Flexible Window (¬±7 days)</strong>.
            Try to return to your Target Treatment Date for subsequent appointments.
        </div>
        <div id="scheduleList" class="schedule-grid"></div>

        <div class="load-more hidden" id="loadMoreContainer">
            <button class="btn btn-outline" onclick="loadMoreAppointments()">
                Load Next 3 Appointments
            </button>
        </div>

        <div class="action-buttons">
            <button class="btn btn-secondary" onclick="goBack('step3')">
                ‚Üê Modify Settings
            </button>
            <button class="btn btn-primary" onclick="downloadPDF()">
                üìÑ Download PDF
            </button>
            <button class="btn btn-primary" onclick="downloadAllICS()">
                üìÖ Export to Calendar
            </button>
        </div>
    </div>

    <!-- Calendar Modal -->
    <div id="calendarModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title" id="modalTitle">Select Appointment Date</h3>
            <div class="calendar-wrapper">
                <div class="month-nav">
                    <button onclick="previousMonth()">‚Äπ</button>
                    <h3 id="monthYear"></h3>
                    <button onclick="nextMonth()">‚Ä∫</button>
                </div>
                <div class="calendar" id="calendar"></div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color target"></div>
                        <span>Target Date</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color flexible"></div>
                        <span>Flexible Window (¬±7 days)</span>
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>
    </div>

    <script>
        // Global state
        let treatmentType = null; // 'new' or 'continuation'
        let leadInType = null; // 'oral' or 'direct' (for new treatment)
        let schedule = [];
        let currentAppointmentIndex = null;
        let currentCalendarMonth = new Date();
        let visibleAppointments = 3;
        const MAX_APPOINTMENTS = 12;

        function selectTreatmentType(type) {
            treatmentType = type;
            document.getElementById('step1').classList.add('hidden');

            if (type === 'new') {
                document.getElementById('step2a').classList.remove('hidden');
            } else {
                document.getElementById('step3').classList.remove('hidden');
            }
        }

        function selectLeadIn(type) {
            leadInType = type;
            document.getElementById('step2a').classList.add('hidden');

            if (type === 'oral') {
                document.getElementById('step2b').classList.remove('hidden');
                // Set minimum date to 28 days ago
                const minDate = new Date();
                minDate.setDate(minDate.getDate() - 28);
                document.getElementById('oralCompleteDate').min = minDate.toISOString().split('T')[0];
            } else {
                document.getElementById('step3').classList.remove('hidden');
            }
        }

        function proceedFromOralLeadIn() {
            const oralCompleteDate = document.getElementById('oralCompleteDate').value;
            if (!oralCompleteDate) {
                alert('Please select the date you completed oral lead-in');
                return;
            }

            document.getElementById('step2b').classList.add('hidden');
            document.getElementById('step3').classList.remove('hidden');

            // Set minimum target date to day after oral completion
            const minDate = new Date(oralCompleteDate + 'T00:00:00');
            minDate.setDate(minDate.getDate() + 1);
            document.getElementById('targetDate').min = minDate.toISOString().split('T')[0];
        }

        function goBack(targetStep) {
            // Hide all steps
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2a').classList.add('hidden');
            document.getElementById('step2b').classList.add('hidden');
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('step4').classList.add('hidden');

            // Show target step
            document.getElementById(targetStep).classList.remove('hidden');
        }

        function goBackFromStep3() {
            if (treatmentType === 'new') {
                if (leadInType === 'oral') {
                    goBack('step2b');
                } else {
                    goBack('step2a');
                }
            } else {
                goBack('step1');
            }
        }

        // Check if selected day is after 28th
        document.getElementById('targetDate').addEventListener('change', function () {
            const date = new Date(this.value + 'T00:00:00');
            const day = date.getDate();
            const warning = document.getElementById('dateWarning');

            if (day > 28) {
                warning.classList.remove('hidden');
            } else {
                warning.classList.add('hidden');
            }
        });

        function generateSchedule() {
            const targetDateInput = document.getElementById('targetDate').value;
            const targetTime = document.getElementById('targetTime').value;

            if (!targetDateInput) {
                alert('Please select a target treatment date');
                return;
            }

            const targetDate = new Date(targetDateInput + 'T00:00:00');
            const intervalMonths = treatmentType === 'continuation' ? 2 : 1;

            schedule = [];
            visibleAppointments = 3;

            for (let i = 0; i < MAX_APPOINTMENTS; i++) {
                const appointmentDate = addMonths(targetDate, i * intervalMonths);
                const targetDay = targetDate.getDate();

                // Adjust for months with fewer days
                if (appointmentDate.getDate() !== targetDay) {
                    appointmentDate.setDate(0); // Go to last day of previous month
                }

                schedule.push({
                    number: i + 1,
                    targetDate: new Date(appointmentDate),
                    selectedDate: new Date(appointmentDate),
                    windowStart: addDays(appointmentDate, -7),
                    windowEnd: addDays(appointmentDate, 7),
                    time: targetTime
                });
            }

            displaySchedule();
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('step4').classList.remove('hidden');
        }

        function displaySchedule() {
            const container = document.getElementById('scheduleList');
            container.innerHTML = '';

            const displayCount = Math.min(visibleAppointments, schedule.length);

            for (let i = 0; i < displayCount; i++) {
                const appointment = schedule[i];
                const card = document.createElement('div');
                card.className = 'appointment-card';

                const isModified = appointment.selectedDate.getTime() !== appointment.targetDate.getTime();
                const isOutsideWindow = !isDateInRange(
                    appointment.selectedDate,
                    appointment.windowStart,
                    appointment.windowEnd
                );

                card.innerHTML = `
                    <div class="appointment-header">
                        <div class="appointment-number">${appointment.number}</div>
                        <div class="appointment-info">
                            <div class="appointment-title">
                                ${treatmentType === 'continuation' ? 'Continuation' : 'Treatment'} 
                                Injection ${appointment.number}
                            </div>
                            <div class="appointment-date">
                                ${isModified ? '<span style="color: #f59e0b;">Modified:</span> ' : ''}
                                ${formatDateLong(appointment.selectedDate)} at ${appointment.time}
                            </div>
                            ${isOutsideWindow ? '<div style="color: #dc2626; font-weight: 600; margin-top: 0.5rem;">‚ö†Ô∏è Outside flexible window</div>' : ''}
                        </div>
                        <button class="change-date-btn" onclick="openCalendar(${i})">
                            Change Date
                        </button>
                    </div>
                    <div class="appointment-window">
                        <div class="window-item earliest">
                            <span class="window-label">Earliest Date:</span>
                            <span class="window-date">${formatDateShort(appointment.windowStart)}</span>
                        </div>
                        <div class="window-item target">
                            <span class="window-label">Target Date:</span>
                            <span class="window-date">${formatDateShort(appointment.targetDate)}</span>
                        </div>
                        <div class="window-item latest">
                            <span class="window-label">Latest Date:</span>
                            <span class="window-date">${formatDateShort(appointment.windowEnd)}</span>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            }

            // Show/hide load more button
            const loadMoreContainer = document.getElementById('loadMoreContainer');
            if (visibleAppointments < MAX_APPOINTMENTS) {
                loadMoreContainer.classList.remove('hidden');
            } else {
                loadMoreContainer.classList.add('hidden');
            }
        }

        function loadMoreAppointments() {
            visibleAppointments = Math.min(visibleAppointments + 3, MAX_APPOINTMENTS);
            displaySchedule();
        }

        function openCalendar(appointmentIndex) {
            currentAppointmentIndex = appointmentIndex;
            const appointment = schedule[appointmentIndex];
            document.getElementById('modalTitle').textContent =
                `Select Date for Appointment ${appointment.number}`;
            currentCalendarMonth = new Date(appointment.selectedDate);
            renderCalendar();
            document.getElementById('calendarModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('calendarModal').classList.remove('active');
        }

        function renderCalendar() {
            const appointment = schedule[currentAppointmentIndex];
            const year = currentCalendarMonth.getFullYear();
            const month = currentCalendarMonth.getMonth();

            document.getElementById('monthYear').textContent =
                currentCalendarMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);

            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';

            // Headers
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-header';
                header.textContent = day;
                calendar.appendChild(header);
            });

            // Previous month days
            const firstDayOfWeek = firstDay.getDay();
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.textContent = prevLastDay.getDate() - i;
                calendar.appendChild(day);
            }

            // Current month days
            for (let i = 1; i <= lastDay.getDate(); i++) {
                const day = document.createElement('div');
                const currentDate = new Date(year, month, i);
                day.className = 'calendar-day';
                day.textContent = i;

                if (isSameDay(currentDate, appointment.targetDate)) {
                    day.classList.add('target');
                } else if (isDateInRange(currentDate, appointment.windowStart, appointment.windowEnd)) {
                    day.classList.add('flexible');
                }

                if (isSameDay(currentDate, appointment.selectedDate)) {
                    day.classList.add('selected');
                }

                day.onclick = () => selectDate(currentDate);
                calendar.appendChild(day);
            }

            // Next month days
            const remainingDays = 42 - calendar.children.length + 7;
            for (let i = 1; i <= remainingDays; i++) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.textContent = i;
                calendar.appendChild(day);
            }
        }

        function previousMonth() {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + 1);
            renderCalendar();
        }

        function selectDate(date) {
            schedule[currentAppointmentIndex].selectedDate = new Date(date);
            displaySchedule();
            closeModal();
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFillColor(10, 77, 60);
            doc.rect(0, 0, 210, 45, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('xVaccine Treatment Plan', 20, 20);
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`${treatmentType === 'continuation' ? 'Continuation' : 'New'} Treatment Schedule`, 20, 30);
            if (treatmentType === 'new' && leadInType === 'oral') {
                doc.text('With Oral Lead-in', 20, 37);
            }

            // Patient info
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 55);
            doc.text(`Interval: ${treatmentType === 'continuation' ? '2 months' : '1 month'}`, 20, 61);

            // Schedule table
            let yPos = 75;
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Appointment Schedule', 20, yPos);
            yPos += 8;

            const displayCount = Math.min(visibleAppointments, schedule.length);

            for (let i = 0; i < displayCount; i++) {
                const appointment = schedule[i];

                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text(`Appointment ${appointment.number}`, 20, yPos);

                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                yPos += 6;
                doc.text(`Scheduled: ${formatDateLong(appointment.selectedDate)} at ${appointment.time}`, 25, yPos);
                yPos += 5;
                doc.text(`Target Date: ${formatDateShort(appointment.targetDate)}`, 25, yPos);
                yPos += 5;
                doc.text(`Earliest: ${formatDateShort(appointment.windowStart)} | Latest: ${formatDateShort(appointment.windowEnd)}`, 25, yPos);

                const isOutsideWindow = !isDateInRange(
                    appointment.selectedDate,
                    appointment.windowStart,
                    appointment.windowEnd
                );
                if (isOutsideWindow) {
                    doc.setTextColor(220, 38, 38);
                    yPos += 5;
                    doc.text('Outside flexible window', 25, yPos);
                    doc.setTextColor(0, 0, 0);
                }

                yPos += 12;

                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
            }

            // Important notes
            yPos += 5;
            if (yPos > 230) {
                doc.addPage();
                yPos = 20;
            }

            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Important Information:', 20, yPos);
            yPos += 8;

            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            const notes = [
                '‚Ä¢ Target dates represent optimal treatment timing',
                '‚Ä¢ Flexible window allows scheduling ¬±7 days from target date',
                '‚Ä¢ Return to your original target date for subsequent injections when possible',
                '‚Ä¢ If unable to attend within flexible window, contact your healthcare provider',
                '‚Ä¢ Bring this schedule to all appointments'
            ];

            notes.forEach(note => {
                doc.text(note, 20, yPos);
                yPos += 6;
            });

            doc.save('xVaccine-Treatment-Schedule.pdf');
        }

        function downloadAllICS() {
            const displayCount = Math.min(visibleAppointments, schedule.length);
            for (let i = 0; i < displayCount; i++) {
                downloadICS(schedule[i]);
            }
        }

        function downloadICS(appointment) {
            const [hours, minutes] = appointment.time.split(':');
            const startDate = new Date(appointment.selectedDate);
            startDate.setHours(parseInt(hours), parseInt(minutes), 0);

            const event = {
                start: startDate,
                duration: 60,
                title: `xVaccine - Appointment ${appointment.number}`,
                description: `xVaccine ${treatmentType === 'continuation' ? 'Continuation' : 'Treatment'} Injection\\n\\nTarget Date: ${formatDateShort(appointment.targetDate)}\\nFlexible Window: ${formatDateShort(appointment.windowStart)} to ${formatDateShort(appointment.windowEnd)}\\n\\nPlease arrive 15 minutes early.`,
                location: 'Healthcare Provider Office',
                url: ''
            };

            const icsContent = generateICS(event);
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `xVaccine-Appointment-${appointment.number}.ics`;
            link.click();
        }

        function generateICS(event) {
            const startDate = formatICSDate(event.start);
            const endDate = formatICSDate(addMinutes(event.start, event.duration));
            const now = formatICSDate(new Date());

            return `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//xVaccine Treatment Planner//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
DTSTART:${startDate}
DTEND:${endDate}
DTSTAMP:${now}
UID:${Date.now()}-${Math.random()}@xvaccine-planner
SUMMARY:${event.title}
DESCRIPTION:${event.description}
LOCATION:${event.location}
STATUS:CONFIRMED
SEQUENCE:0
BEGIN:VALARM
TRIGGER:-PT24H
ACTION:DISPLAY
DESCRIPTION:Reminder: ${event.title} tomorrow
END:VALARM
END:VEVENT
END:VCALENDAR`;
        }

        // Utility functions
        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        function addMonths(date, months) {
            const result = new Date(date);
            result.setMonth(result.getMonth() + months);
            return result;
        }

        function addMinutes(date, minutes) {
            return new Date(date.getTime() + minutes * 60000);
        }

        function formatDateLong(date) {
            return date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatDateShort(date) {
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatICSDate(date) {
            const pad = (n) => n.toString().padStart(2, '0');
            return date.getFullYear() +
                pad(date.getMonth() + 1) +
                pad(date.getDate()) + 'T' +
                pad(date.getHours()) +
                pad(date.getMinutes()) +
                pad(date.getSeconds());
        }

        function isSameDay(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                date1.getMonth() === date2.getMonth() &&
                date1.getDate() === date2.getDate();
        }

        function isDateInRange(date, start, end) {
            return date >= start && date <= end;
        }

        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('targetDate').min = today;

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {
                console.log('Service worker registration optional');
            });
        }
    </script>
</body>

</html>